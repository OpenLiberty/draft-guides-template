// ----------- BEGIN -----------
// Copyright (c) 2019, 2022 IBM Corporation and others.
// Licensed under Creative Commons Attribution-NoDerivatives
// 4.0 International (CC BY-ND 4.0)
//   https://creativecommons.org/licenses/by-nd/4.0/
//
// Contributors:
//     IBM Corporation
//

// :projectid: paketo-buildpacks-intro
:page-layout: guide-multipane
// :page-duration: 15 minutes
// :page-releasedate: TBD
:page-description: Learn how to migrate an application using Cloud Foundry buildpacks to Paketo buildpacks. 
// :page-tags: 
// :page-permalink: /guides/{projectid}
// :page-related-guides: ['docker', 'kubernetes-intro']
// :common-includes: https://raw.githubusercontent.com/OpenLiberty/guides-common/prod
// :page-guide-category: 
:page-essential: true
// :page-essential-order: 3
:source-highlighter: prettify
// :page-seo-title: 
// :page-seo-description: 
// :common-includes: ../guides-common/
// :imagesdir: /img/guide/{projectid}

// :guide-author: Open Liberty
= Migrating an application using Cloud Foundry Buildpacks to Paketo Buildpacks

You will explore how to migrate an application using Cloud Foundry liberty-for-java buildpack to using Paketo buildpacks.

// =================================================================================================
//  What you'll learn
// =================================================================================================

== What you'll learn

Learn how to migrate an application using Cloud Foundry liberty-for-java buildpack to using Paketo buildpacks. You will learn how to migrate and use advanced features of the Paketo buildpack. 

The migration includes learning how to use the following features: 

* Simple migration
* Providing server.xml at build time 
* Using different profiles (full, jakarta9, webProfile9, webProfile8, javaee8, microProfile4, microProfile5, kernel)
* Building from a Liberty Server 
* Building from a Packaged Server.
* Installing custom features 
* Installing iFixes
* Using UBI images 

== Additional prerequisites

* Your application source 
* https://hub.docker.com/search?type=edition&offering=community&q=[Docker]
* The https://buildpacks.io/docs/tools/pack/[pack CLI]
 
== Simple migration 
//start with getting started blog post
//simple migration - push using a war file
//paketo.io and buildpacks.io website as references

[width="100%", cols="10, 10"]
[source, adoc]
|=========
|*Cloud Foundry Buildpack Commands* |*Paketo Buildpacks Commands* 
// a| Navigate to source code repository (will use Getting started app for example)
// // delete cell
// [source, console]
// git clone https://github.com/IBM-Cloud/get-started-java


  
// a| Navigate to source code repository (will use Getting started app for example)
// //delete cell
// [source, console]
// git clone https://github.com/openliberty/guide-getting-started.git
// cd guide-getting-started/finish

// a| Run app locally using command line 
// [source, console]
// cd get-started-java
// mvn clean install
// mvn install liberty:run-server

// a| Create an OCI image and run application locally
// [source, console]
// pack config default-builder gcr.io/paketo-buildpacks/builder:base

// [source, console]
// pack build --env BP_JAVA_APP_SERVER=liberty --env BP_LIBERTY_PROFILE=jakartaee9 \
//   --buildpack paketo-buildpacks/eclipse-openj9 --buildpack paketo-buildpacks/java myapp

// [source, console]
// docker run --rm -p 9080:9080 myapp


a| Push app using cloud foundry
[source, console]
cf push -p myApp.war

a| Create an OCI image and run application locally
//Say something about the pack config command what it does

The pack config command sets the default builder using the pack CLI.
[source, console]
pack config default-builder gcr.io/paketo-buildpacks/builder:base

The pack build command uses Cloud Native Buildpacks to create an app image from the source code. More info found here: https://buildpacks.io/docs/tools/pack/cli/pack_build/[pack build] 
[source, console]
pack build --env BP_JAVA_APP_SERVER=liberty 
// --env BP_LIBERTY_PROFILE=jakartaee9 \
//   --buildpack paketo-buildpacks/eclipse-openj9 --buildpack paketo-buildpacks/java myapp

[source, console]
docker run --rm -p 9080:9080 myapp
// a| Build app from an on-prem Open Liberty installation
// [source, console]
// bin/server package defaultServer --include=usr

// [source, console]
// pack build --path <packaged-server-zip-path> \
//  --buildpack paketo-buildpacks/eclipse-openj9 \
//  --buildpack paketo-buildpacks/java myapp

|=========

== Providing server.xml at build time

[width="100%", cols="10, 10"]
[source, adoc]
|=========
|*Cloud Foundry Buildpack Commands* |*Paketo Buildpacks Commands* 

a| Custom Liberty server configuration with your app

Install the Liberty profile to your workstation. Instructions found here: https://cloud.ibm.com/docs/cloud-foundry-public?topic=cloud-foundry-public-options_for_pushing#server_directory[Server directory]

Run the command:
[source, console]
cf push <yourappname> -p wlp/usr/servers/defaultServer

a| Using server.xml at build time:author:

Run the following commands: 

Navigate to getting-started-java directory or any sample app
[source, console]
pack config default-builder gcr.io/paketo-buildpacks/builder:base

Build the application on Liberty:
[source, console]
pack build --env BP_JAVA_APP_SERVER=liberty

When providing server configuration files like server.xml, these files can only be included in the build by telling the Maven or Gradle buildpacks to provide them. The following environment variables need to be set in your pack build command.

Server Config with Maven applications
[source, console]
--env BP_MAVEN_BUILT_ARTIFACT="target/*.[ejw]ar src/main/liberty/config/*"

Server Config with Gradle applications
[source, console]
--env BP_GRADLE_BUILT_ARTIFACT="build/libs/*.[ejw]ar src/main/liberty/config/*"

//Add a generic location for server config file. Using bindings 

Check if the server.xml file is in the directory: 
[source, console]
docker exec -it $(docker ps -q) /bin/bash

a| Binding service 

[source, console]
cf bind-service

a| Using bindings - providing server config at build and runtime

Providing server config at build-time and runtime used for secret configuration. Bindings provide credentials and location needed to connect to external services. First create the bindings/liberty folder and add the type file with liberty. Add any config you want to provide at runtime in the directory and the nmount the folder during docker run with --volume $(pwd)/bindings:/platform/bindings

[source, console]
docker run --env SERVICE_BINDING_ROOT=/bindings --volume <absolute-path-to-binding>:/bindings/<binding-name> <image-name>

|=========


=== Using different profiles 
//Offering different profiles javaee6, javaee7, javaee8
* Full, jakarta9, webProfile9, webProfile8, javaee8, microProfile4, microProfile5, kernel

[width="100%", cols="10, 10"]
[source, adoc]
|=========
|*Cloud Foundry Buildpack Commands* |*Paketo Buildpacks Commands* 



|=========
== Advanced migrations

=== Using UBI images 

=== Installing iFixes 

=== Installing customer features

=== Building from a Liberty server 

=== Building from a Packaged Server

// ------------ END ------------